<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Responsibility Planner â€” NorthPoint</title>
<link rel="stylesheet" href="/northpoint.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/auth.js"></script>
<style>
/* â”€â”€ AUTH â”€â”€ */
.auth-screen {
  position: fixed; inset: 0; background: var(--navy);
  display: flex; align-items: center; justify-content: center; z-index: 1000;
}
.auth-box {
  background: #1e293b; border: 1px solid rgba(255,255,255,0.1);
  border-radius: 20px; padding: 48px; width: 400px;
}
.auth-logo {
  width: 44px; height: 44px; background: var(--accent); border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 24px; box-shadow: 0 0 24px rgba(59,130,246,0.4);
}
.auth-logo svg { width: 22px; height: 22px; }
.auth-title { font-family: 'DM Serif Display', serif; font-size: 28px; color: white; margin-bottom: 6px; }
.auth-sub { font-size: 13px; color: var(--text-tertiary); margin-bottom: 32px; }
.auth-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-tertiary); margin-bottom: 6px; display: block; }
.auth-input {
  width: 100%; padding: 11px 14px; background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12); border-radius: 10px;
  color: white; font-size: 14px; font-family: inherit; margin-bottom: 16px; transition: border-color 0.2s;
}
.auth-input:focus { outline: none; border-color: var(--accent); }
.auth-input::placeholder { color: rgba(255,255,255,0.25); }
.auth-btn {
  width: 100%; padding: 12px; background: var(--accent); border: none;
  border-radius: 10px; color: white; font-size: 14px; font-weight: 600;
  font-family: inherit; cursor: pointer; transition: opacity 0.2s; margin-top: 4px;
}
.auth-btn:hover { opacity: 0.9; }
.auth-error { font-size: 12px; color: #f87171; margin-top: 8px; min-height: 18px; }

/* â”€â”€ FUTURE STATE â€” subtle upgrade â”€â”€ */
body.future-mode { --bg: #f0f4f8; --card: #f8fafc; --silver: #d8e2ee; --silver-light: #eaf0f7; }
body.future-mode .topbar { background: #1e293b; border-color: rgba(255,255,255,0.08); }
body.future-mode .topbar-name { color: #e2e8f0; }
body.future-mode .topbar-sep { background: rgba(255,255,255,0.12); }
body.future-mode .topbar-section { color: #94a3b8; }
body.future-mode .action-bar { background: #1e293b; border-color: rgba(255,255,255,0.08); }
body.future-mode .column { background: #e8f0f9; }
body.future-mode .column-name { color: #3b82f6; }
body.future-mode .resp-card { background: #ffffff; border-color: #c8d8ea; }
body.future-mode .resp-card.is-key { border-color: var(--green); background: #f0fdf8; box-shadow: 0 0 0 1px rgba(16,185,129,0.2); }
body.future-mode .action-btn { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.15); color: #94a3b8; }
body.future-mode .action-btn:hover { border-color: #38bdf8; color: #38bdf8; }

/* â”€â”€ TABS â”€â”€ */
.tab-bar {
  display: flex; align-items: center; gap: 4px; padding: 12px 32px 0;
  border-bottom: 1px solid var(--silver); background: var(--card);
  flex-shrink: 0; transition: background 0.3s, border-color 0.3s;
}
body.future-mode .tab-bar { background: #1e293b; border-color: rgba(255,255,255,0.08); }
.tab-btn {
  padding: 8px 16px; border: none; background: none; font-family: inherit;
  font-size: 13px; font-weight: 500; color: var(--text-tertiary); cursor: pointer;
  border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.18s;
}
.tab-btn:hover { color: var(--text-primary); }
body.future-mode .tab-btn:hover { color: #e2e8f0; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
body.future-mode .tab-btn { color: #64748b; }
body.future-mode .tab-btn.active { color: #38bdf8; border-bottom-color: #38bdf8; }

/* â”€â”€ ACTION BAR â”€â”€ */
.action-bar {
  display: flex; align-items: center; gap: 8px; padding: 10px 32px;
  border-bottom: 1px solid var(--silver); background: var(--card); flex-shrink: 0;
  transition: background 0.3s, border-color 0.3s;
}
.action-btn {
  display: flex; align-items: center; gap: 6px; padding: 7px 14px;
  border-radius: 8px; border: 1px solid var(--silver); background: var(--card);
  color: var(--text-secondary); font-size: 12px; font-weight: 600; font-family: inherit;
  cursor: pointer; transition: all 0.18s;
}
.action-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
.action-btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
.action-btn.primary:hover { opacity: 0.9; background: var(--accent); color: white; }
.action-btn svg { width: 14px; height: 14px; flex-shrink: 0; }
.unsaved-badge {
  display: none; align-items: center; gap: 5px;
  font-size: 11px; color: var(--amber); font-weight: 600;
}
.unsaved-badge.visible { display: flex; }
.action-bar-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
.state-toggle { display: flex; align-items: center; background: var(--silver-light); border-radius: 10px; padding: 3px; gap: 2px; }
body.future-mode .state-toggle { background: rgba(255,255,255,0.08); }
.state-btn {
  display: flex; align-items: center; gap: 6px; padding: 6px 14px;
  border-radius: 8px; border: none; cursor: pointer; font-size: 12px;
  font-weight: 600; font-family: inherit; transition: all 0.2s; background: none; color: var(--text-tertiary);
}
.state-btn.active-current { background: white; color: var(--text-primary); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.state-btn.active-future { background: #0f172a; color: #38bdf8; box-shadow: 0 1px 8px rgba(56,189,248,0.2); }
.state-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.dot-current { background: var(--amber); }
.dot-future { background: var(--green); }
.user-chip {
  display: flex; align-items: center; gap: 6px; padding: 5px 10px;
  border-radius: 8px; border: 1px solid var(--silver); background: var(--card);
  font-size: 12px; color: var(--text-secondary); cursor: pointer; position: relative;
}
body.future-mode .user-chip { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); color: #94a3b8; }
.user-avatar-sm {
  width: 20px; height: 20px; border-radius: 5px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; font-weight: 700; color: white;
}
.user-dropdown {
  position: absolute; top: calc(100% + 8px); right: 0; background: var(--navy);
  border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 8px;
  min-width: 180px; display: none; z-index: 300;
}
.user-dropdown.open { display: block; }
.user-dropdown-name { font-size: 12px; color: white; font-weight: 600; padding: 6px 10px 2px; }
.user-dropdown-email { font-size: 11px; color: var(--text-tertiary); padding: 0 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 4px; }
.signout-btn { width: 100%; padding: 7px 10px; border: none; background: none; color: #f87171; font-size: 12px; font-family: inherit; text-align: left; cursor: pointer; border-radius: 6px; }
.signout-btn:hover { background: rgba(248,113,113,0.1); }

/* â”€â”€ KANBAN â”€â”€ */
.kanban-wrap { flex: 1; overflow-x: auto; overflow-y: hidden; padding: 20px 32px; }
.kanban-board { display: flex; gap: 12px; min-width: max-content; align-items: flex-start; }
.tab-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
.tab-panel.active { display: flex; }

/* â”€â”€ COLUMN â”€â”€ */
.column {
  width: 236px; flex-shrink: 0; background: var(--silver-light);
  border-radius: 14px; display: flex; flex-direction: column;
  max-height: calc(100vh - 200px); transition: background 0.3s;
}
.column.drag-over { background: var(--accent-glow); outline: 2px dashed var(--accent); }
body.future-mode .column.drag-over { background: rgba(56,189,248,0.08); outline-color: #38bdf8; }
.column-header { padding: 12px 14px 8px; flex-shrink: 0; }
.column-avatar {
  width: 26px; height: 26px; border-radius: 7px; display: flex; align-items: center;
  justify-content: center; font-size: 10px; font-weight: 700; color: white; margin-bottom: 6px;
}
.column-name { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-tertiary); margin-bottom: 1px; transition: color 0.3s; }
.column-count { font-size: 11px; color: var(--text-tertiary); }
.column-cards { flex: 1; overflow-y: auto; padding: 0 8px 8px; display: flex; flex-direction: column; gap: 5px; min-height: 60px; }
.column-cards::-webkit-scrollbar { width: 3px; }
.column-cards::-webkit-scrollbar-thumb { background: var(--silver); border-radius: 2px; }
.column-empty { font-size: 11px; color: var(--text-tertiary); text-align: center; padding: 16px 8px; border: 1.5px dashed var(--silver); border-radius: 9px; }

/* â”€â”€ ADD TO BACKLOG â”€â”€ */
.backlog-add { padding: 0 8px 8px; flex-shrink: 0; }
.backlog-textarea {
  width: 100%; padding: 8px 10px; border: 1px solid var(--silver); border-radius: 8px;
  background: var(--card); font-size: 11.5px; font-family: inherit; color: var(--text-primary);
  resize: none; height: 56px; transition: border-color 0.2s;
}
.backlog-textarea:focus { outline: none; border-color: var(--accent); }
.backlog-textarea::placeholder { color: var(--text-tertiary); }
.backlog-add-btn {
  width: 100%; margin-top: 5px; padding: 6px; border: none; border-radius: 7px;
  background: var(--accent); color: white; font-size: 11px; font-weight: 600;
  font-family: inherit; cursor: pointer; transition: opacity 0.2s;
}
.backlog-add-btn:hover { opacity: 0.85; }

/* â”€â”€ CARD â”€â”€ */
.resp-card {
  background: var(--card); border: 1.5px solid var(--silver); border-radius: 9px;
  padding: 9px 11px; cursor: grab; transition: all 0.18s; user-select: none;
}
.resp-card:hover { box-shadow: 0 3px 10px rgba(15,23,42,0.08); transform: translateY(-1px); }
.resp-card.dragging { opacity: 0.35; cursor: grabbing; }
.resp-card.is-key { border-color: var(--amber); background: #fffdf5; box-shadow: 0 0 0 1px rgba(245,158,11,0.2); }
body.future-mode .resp-card.is-key { border-color: var(--green); background: #f0fdf8; }
.card-text { font-size: 12px; color: var(--text-secondary); line-height: 1.45; margin-bottom: 7px; }
.resp-card.is-key .card-text { color: var(--text-primary); font-weight: 500; }
.card-footer { display: flex; align-items: center; justify-content: space-between; }
.card-state-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 7px; border-radius: 20px; }
.badge-current { background: rgba(245,158,11,0.12); color: var(--amber); }
.badge-future { background: rgba(16,185,129,0.12); color: var(--green); }
.card-actions { display: flex; align-items: center; gap: 3px; }
/* Key toggle â€” outline key â†’ filled key */
.key-toggle {
  width: 22px; height: 22px; border-radius: 6px; border: 1.5px solid var(--silver);
  background: none; cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.18s; font-size: 12px;
  filter: grayscale(1) opacity(0.35);
}
.key-toggle:hover { border-color: var(--amber); filter: none; }
.resp-card.is-key .key-toggle { border-color: var(--amber); background: #fffbeb; filter: none; }
body.future-mode .resp-card.is-key .key-toggle { border-color: var(--green); background: #f0fdf4; }
.tasks-toggle {
  width: 22px; height: 22px; border-radius: 6px; border: 1.5px solid var(--silver);
  background: none; cursor: pointer; display: flex; align-items: center;
  justify-content: center; font-size: 9px; color: var(--text-tertiary);
  transition: all 0.18s;
}
.tasks-toggle:hover { border-color: var(--accent); color: var(--accent); }
.card-tasks { display: none; margin-top: 7px; padding-top: 7px; border-top: 1px solid var(--silver-light); }
.card-tasks.open { display: block; }
.card-task-item { font-size: 11px; color: var(--text-tertiary); padding: 2px 0 2px 10px; position: relative; line-height: 1.4; }
.card-task-item::before { content: 'Â·'; position: absolute; left: 3px; }

/* â”€â”€ HEATMAP TAB â”€â”€ */
.heatmap-wrap { flex: 1; overflow: auto; padding: 24px 32px; }
.heatmap-intro { max-width: 600px; margin-bottom: 28px; }
.heatmap-intro h2 { font-family: 'DM Serif Display', serif; font-size: 28px; color: var(--text-primary); margin-bottom: 8px; font-weight: 400; }
.heatmap-intro p { font-size: 13.5px; color: var(--text-secondary); line-height: 1.65; }
body.future-mode .heatmap-intro h2 { color: #e2e8f0; }
body.future-mode .heatmap-intro p { color: #94a3b8; }
.heatmap-legend { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 24px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
.legend-dot { width: 12px; height: 12px; border-radius: 3px; }
.legend-dot.sole { background: #1d4ed8; }
.legend-dot.shared { background: #93c5fd; }
.legend-dot.key { background: var(--amber); }
.heatmap-table-wrap { overflow-x: auto; border-radius: 14px; border: 1px solid var(--silver); }
body.future-mode .heatmap-table-wrap { border-color: #c8d8ea; }
.heatmap-table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 640px; }
.heatmap-table th {
  background: var(--silver-light); padding: 10px 14px; text-align: left;
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600;
  color: var(--text-tertiary); border-bottom: 1px solid var(--silver); white-space: nowrap;
}
body.future-mode .heatmap-table th { background: #1e293b; color: #64748b; border-color: rgba(255,255,255,0.08); }
.heatmap-table th:first-child { min-width: 240px; }
.heatmap-table th:not(:first-child) { text-align: center; min-width: 80px; }
.heatmap-table tr { border-bottom: 1px solid var(--silver-light); transition: background 0.15s; }
.heatmap-table tr:last-child { border-bottom: none; }
.heatmap-table tbody tr:hover { background: var(--silver-light); }
body.future-mode .heatmap-table tr { border-color: rgba(255,255,255,0.05); }
body.future-mode .heatmap-table tbody tr:hover { background: rgba(255,255,255,0.03); }
.heatmap-table td { padding: 8px 14px; color: var(--text-secondary); vertical-align: middle; }
body.future-mode .heatmap-table td { color: #94a3b8; background: #1a2744; }
body.future-mode .heatmap-table th { background: #162036; }
.heatmap-table td:not(:first-child) { text-align: center; }
.hm-cell { width: 28px; height: 28px; border-radius: 7px; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; margin: 0 auto; }
.hm-cell.sole { background: #1d4ed8; color: white; font-weight: 700; }
.hm-cell.shared { background: #bfdbfe; color: #1d4ed8; font-weight: 600; }
.hm-cell.key-owner { background: var(--amber); color: white; font-weight: 700; font-size: 13px; }
.hm-cell.empty { background: transparent; }
.hm-section-row td { background: var(--silver-light) !important; color: var(--text-tertiary) !important; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; padding: 5px 14px; }
body.future-mode .hm-section-row td { background: #0f172a !important; color: #475569 !important; }

/* â”€â”€ LOG DRAWER â”€â”€ */
.log-drawer {
  position: fixed; right: 0; top: 0; bottom: 0; width: 340px;
  background: var(--card); border-left: 1px solid var(--silver);
  transform: translateX(100%); transition: transform 0.3s; z-index: 500; display: flex; flex-direction: column;
}
body.future-mode .log-drawer { background: #1e293b; border-color: rgba(255,255,255,0.1); }
.log-drawer.open { transform: translateX(0); }
.log-header { padding: 18px 22px; border-bottom: 1px solid var(--silver); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
body.future-mode .log-header { border-color: rgba(255,255,255,0.08); }
.log-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
body.future-mode .log-title { color: #e2e8f0; }
.log-close { width: 26px; height: 26px; border-radius: 6px; border: 1px solid var(--silver); background: none; cursor: pointer; font-size: 16px; color: var(--text-tertiary); display: flex; align-items: center; justify-content: center; }
.log-close:hover { background: var(--silver-light); }
.log-list { flex: 1; overflow-y: auto; padding: 14px 22px; }
.log-item { padding: 9px 0; border-bottom: 1px solid var(--silver-light); }
body.future-mode .log-item { border-color: rgba(255,255,255,0.06); }
.log-item:last-child { border-bottom: none; }
.log-action { font-size: 12px; color: var(--text-primary); line-height: 1.4; margin-bottom: 3px; }
body.future-mode .log-action { color: #e2e8f0; }
.log-meta { font-size: 11px; color: var(--text-tertiary); }
.log-empty { font-size: 13px; color: var(--text-tertiary); text-align: center; padding: 40px 0; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--navy); color: white; font-size: 13px; font-weight: 500;
  padding: 10px 20px; border-radius: 10px; opacity: 0; transition: all 0.3s;
  pointer-events: none; z-index: 1000; white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.success { background: #065f46; }
.toast.error { background: #7f1d1d; }

/* â”€â”€ LOADING â”€â”€ */
.loading-overlay {
  position: fixed; inset: 0; background: var(--navy);
  display: flex; align-items: center; justify-content: center; z-index: 999; flex-direction: column; gap: 16px;
}
.loading-spinner { width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 13px; color: rgba(255,255,255,0.4); }
</style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loadingâ€¦</div>
</div>

<!-- Auth -->
<div class="auth-screen" id="authScreen" style="display:none;">
  <div class="auth-box">
    <div class="auth-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
    </div>
    <div class="auth-title">NorthPoint</div>
    <div class="auth-sub">Sign in to access the Responsibility Planner</div>
    <label class="auth-label">Email</label>
    <input type="email" class="auth-input" id="authEmail" placeholder="you@nacscare.com" />
    <label class="auth-label">Password</label>
    <input type="password" class="auth-input" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    <button class="auth-btn" id="authBtn" onclick="signIn()">Sign In</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Log Drawer -->
<div class="log-drawer" id="logDrawer">
  <div class="log-header">
    <div class="log-title">Change Log</div>
    <button class="log-close" onclick="toggleLog()">Ã—</button>
  </div>
  <div class="log-list" id="logList">
    <div class="log-empty">No changes recorded yet.</div>
  </div>
</div>

<!-- App -->
<div class="layout" id="appLayout" style="display:none;">
  <div id="rail-mount"></div>

  <div class="main">
    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar-left">
        <a href="/index.html" class="topbar-name">NorthPoint</a>
        <div class="topbar-sep"></div>
        <span class="topbar-section">Responsibility Planner</span>
      </div>
      <div class="topbar-right">
        <span class="topbar-date" id="currentDate"></span>
        <div class="topbar-avatar" id="topbarAvatar">?</div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tab-bar">
      <button class="tab-btn active" id="tabKanban" onclick="switchTab('kanban')">Kanban Board</button>
      <button class="tab-btn" id="tabHeatmap" onclick="switchTab('heatmap')">Coverage Heatmap</button>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <button class="action-btn primary" onclick="applyToBios()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Apply to Bios
      </button>
      <button class="action-btn" onclick="saveState()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save
      </button>
      <button class="action-btn" onclick="toggleLog()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Change Log
      </button>
      <button class="action-btn" onclick="clearAll()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg>
        Clear All
      </button>
      <div class="unsaved-badge" id="unsavedBadge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Unsaved changes
      </div>
      <div class="action-bar-right">
        <div class="state-toggle">
          <button class="state-btn active-current" id="btnCurrent" onclick="setState('current')">
            <span class="state-dot dot-current"></span> Current
          </button>
          <button class="state-btn" id="btnFuture" onclick="setState('future')">
            <span class="state-dot dot-future"></span> Future
          </button>
        </div>
        <div class="user-chip" id="userChip" onclick="toggleUserMenu()">
          <div class="user-avatar-sm" id="userAvatarSm">?</div>
          <span id="userChipName">â€”</span>
          <div class="user-dropdown" id="userDropdown">
            <div class="user-dropdown-name" id="dropdownName">â€”</div>
            <div class="user-dropdown-email" id="dropdownEmail">â€”</div>
            <button class="signout-btn" onclick="signOut()">Sign out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Kanban Panel -->
    <div class="tab-panel active" id="panelKanban">
      <div class="kanban-wrap">
        <div class="kanban-board" id="kanbanBoard"></div>
      </div>
    </div>

    <!-- Heatmap Panel -->
    <div class="tab-panel" id="panelHeatmap">
      <div class="heatmap-wrap">
        <div class="heatmap-intro">
          <h2>Coverage Heatmap</h2>
          <p>Shows which responsibilities each team member owns and where work overlaps. Key responsibilities are highlighted in amber. Use this to surface gaps and reduce duplication.</p>
        </div>
        <div class="heatmap-legend">
          <div class="legend-item"><div class="legend-dot key"></div> Key responsibility</div>
          <div class="legend-item"><div class="legend-dot sole"></div> Sole owner</div>
          <div class="legend-item"><div class="legend-dot shared"></div> Shared</div>
        </div>
        <div class="heatmap-table-wrap">
          <table class="heatmap-table" id="heatmapTable">
            <thead>
              <tr>
                <th>Responsibility</th>
                <th>Anthony</th>
                <th>Geremia</th>
                <th>Francis</th>
                <th>Tom</th>
                <th>Rogi</th>
                <th>Jon</th>
              </tr>
            </thead>
            <tbody id="heatmapBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="/nav.js"></script>
<script>
// â”€â”€ SUPABASE â”€â”€ (client provided by /auth.js)
const db = _npSupabase;

// â”€â”€ STATE â”€â”€
let currentState = 'current';
let currentTab = 'kanban';
let currentUser = null;
let boardData = { current: {}, future: {} };
let hasUnsaved = false;
let changeLog = [];
let dragCard = null;
let dragSource = null;

const PEOPLE = [
  { key: 'backlog',  name: 'Unassigned',      initials: 'â€”',  color: null },
  { key: 'anthony',  name: 'Anthony Trujillo', initials: 'AT', color: 'linear-gradient(135deg,#3b82f6,#8b5cf6)' },
  { key: 'geremia',  name: 'Geremia Doan',     initials: 'GD', color: 'linear-gradient(135deg,#10b981,#3b82f6)' },
  { key: 'francis',  name: 'Francis Ferma',    initials: 'FF', color: 'linear-gradient(135deg,#f97316,#ef4444)' },
  { key: 'tom',      name: 'Tom Jarrell',      initials: 'TJ', color: 'linear-gradient(135deg,#8b5cf6,#06b6d4)' },
  { key: 'rogi',     name: 'Rogi Poblete',     initials: 'RP', color: 'linear-gradient(135deg,#f59e0b,#10b981)' },
  { key: 'jon',      name: 'Jon Andrews',      initials: 'JA', color: 'linear-gradient(135deg,#6366f1,#8b5cf6)' },
];

const TEAM = PEOPLE.filter(p => p.key !== 'backlog');

// â”€â”€ SEED DATA â”€â”€
const SEED_CURRENT_TASKS = ["Aligning technology initiatives with the 30 by 30 growth strategy","Supporting executive financial objectives through system planning","Evaluating technology investments against operational scale","Advising leadership on technology risk and tradeoffs","Translating business goals into IT initiatives","Defining lifecycle standards for enterprise applications","Managing onboarding and retirement of major platforms","Evaluating application fit, overlap, and redundancy","Coordinating application changes with stakeholders","Maintaining ownership clarity for core systems","Managing SaaS vendor relationships","Negotiating contracts and renewals","Managing vendor billing issues and disputes","Tracking license usage and compliance","Identifying and addressing shadow IT","Tracking technology spend and savings","Standardizing tools, configurations, and platforms","Defining operating norms across facilities","Establishing service expectations and guardrails","Reducing variance in facility-level implementations","Tracking IT projects and initiatives","Developing IT metrics and KPI dashboards","Reporting service performance and trends","Supporting data-driven IT decisions","Preparing executive-facing IT materials","Providing context during leadership discussions","Supporting executive decision-making on systems and risk","Acting as escalation point for strategic questions","Creating, modifying, disabling, and auditing user accounts","Managing user provisioning and deprovisioning workflows","Reconciling HR (UKG) data with IT systems","Maintaining identity consistency across platforms","Managing group-based access and role assignment","Managing MFA deployment and enforcement","Handling MFA exceptions and recovery","Handling password resets and account recovery","Supporting secure authentication across systems","Managing Google Workspace licensing and entitlements","Managing Google Groups and shared drive structures","Troubleshooting email delivery and routing","Managing spam filtering and email security","Supporting executive email and calendar issues","Investigating suspicious emails and account compromise","Responding to security incidents and escalations","Managing endpoint protection tooling","Executing incident containment and remediation","Supporting post-incident analysis","Managing firewall rules and documentation","Managing vulnerability scanning and patch prioritization","Supporting HIPAA and security audits","Maintaining audit evidence and compliance documentation","Running security awareness and training efforts","Architecting and maintaining SD-WAN infrastructure","Managing switch configurations and VLANs","Managing IP addressing and segmentation","Managing wireless access point configuration","Maintaining network diagrams and documentation","Managing ISP relationships and contracts","Troubleshooting outages and escalations","Coordinating circuit changes and failover behavior","Managing network monitoring tools","Configuring alerts and thresholds","Troubleshooting performance issues","Supporting proactive issue detection","Managing VPN configuration and access","Supporting secure remote connectivity","Troubleshooting remote access issues","Managing server hardware and local infrastructure","Managing virtualization platforms and VMs","Monitoring compute resource usage","Planning and executing server migrations","Coordinating data center transitions","Supporting infrastructure consolidation efforts","Managing backup systems and schedules","Performing backup verification and recovery testing","Supporting disaster recovery planning","Managing UPS systems and power protection","Managing camera system deployments","Managing camera access permissions","Managing video retention and storage","Responding to camera outages or failures","Supporting facility safety technology needs","Procuring laptops and end-user hardware","Imaging and deploying new devices","Managing device replacements and failures","Planning device refresh cycles","Managing e-waste and asset recovery","Managing Apple Business Manager enrollment","Managing mobile device configuration and policies","Locking, wiping, or recovering lost devices","Managing telecom accounts and device plans","Troubleshooting mobile connectivity issues","Managing printer and copier connectivity","Coordinating printer and copier moves","Managing copier lease returns and storage","Troubleshooting printing issues","Managing software licensing and renewals","Auditing license usage and compliance","Coordinating renewals across departments","Monitoring SaaS usage and spend","Identifying cost optimization opportunities","Supporting finance with system access and reporting","Serving as SME for PointClickCare","Managing clinical system access and permissions","Supporting clinical SaaS platforms","Supporting integrations between clinical and billing systems","Identifying workflow bottlenecks","Supporting clinical users during changes","Developing training approaches for clinical systems","Supporting ERP (GP / Dynamics) systems","Managing DocLink configuration and workflows","Managing database operations and maintenance","Performing database patching and performance monitoring","Executing major system migrations","Coordinating cross-functional migration efforts","Supporting users during platform transitions","Managing IT ticket intake and routing","Triage and prioritization of support requests","Resolving end-user support issues","Managing escalation paths","Supporting administrators during system changes","Supporting staff during rollouts and transitions","Managing end-user adoption challenges","Maintaining IT documentation and SOPs","Maintaining the internal IT knowledge base","Maintaining the Commonspace intranet platform","Publishing and updating internal forms and guides","Integrating intake forms with ticketing systems","Maintaining internal automation workflows","Piloting AI-assisted support and automation","Managing IT project intake","Managing project timelines and dependencies","Coordinating cross-department IT initiatives","Supporting business units with system needs","Acting as liaison between IT and departments","Translating operational needs into technical solutions","Managing day-to-day operational decision-making","Handling undefined or misrouted operational work","Acting as the default problem-solver for system ambiguity","Network Administration"];

const SEED_FUTURE = [
  {person:'anthony',responsibility:'IT documentation, intranet, and internal knowledge systems',is_key:false,tasks:'Maintaining IT documentation and SOPs; Maintaining the internal IT knowledge base; Maintaining the Commonspace intranet platform; Publishing and updating internal forms and guides'},
  {person:'anthony',responsibility:'Internal automation, workflow tooling, and AI enablement',is_key:false,tasks:'Integrating intake forms with ticketing systems; Maintaining internal automation workflows; Piloting AI-assisted support and automation'},
  {person:'anthony',responsibility:'IT project intake, prioritization, and delivery management',is_key:false,tasks:'Managing IT project intake; Managing project timelines and dependencies; Coordinating cross-department IT initiatives'},
  {person:'anthony',responsibility:'Cross-department technology enablement and coordination',is_key:true,tasks:'Supporting business units with system needs; Acting as liaison between IT and departments; Translating operational needs into technical solutions'},
  {person:'anthony',responsibility:'Enterprise IT standards, operating models, and success metrics',is_key:true,tasks:'Standardizing tools, configurations, and platforms; Defining operating norms across facilities; Establishing service expectations and guardrails; Reducing variance in facility-level implementations'},
  {person:'anthony',responsibility:'IT strategy alignment with organizational growth and financial objectives',is_key:true,tasks:'Aligning technology initiatives with the 30 by 30 growth strategy; Supporting executive financial objectives through system planning; Evaluating technology investments against operational scale; Advising leadership on technology risk and tradeoffs; Translating business goals into IT initiatives'},
  {person:'anthony',responsibility:'Enterprise application lifecycle ownership (ERP, MDM, eFax, core SaaS)',is_key:false,tasks:'Defining lifecycle standards for enterprise applications; Managing onboarding and retirement of major platforms; Evaluating application fit, overlap, and redundancy; Coordinating application changes with stakeholders; Maintaining ownership clarity for core systems'},
  {person:'anthony',responsibility:'Vendor strategy, contract governance, and software asset management (SAM)',is_key:false,tasks:'Managing SaaS vendor relationships; Negotiating contracts and renewals; Managing vendor billing issues and disputes; Tracking license usage and compliance; Identifying and addressing shadow IT; Tracking technology spend and savings'},
  {person:'anthony',responsibility:'IT metrics, KPIs, and operational reporting',is_key:false,tasks:'Tracking IT projects and initiatives; Developing IT metrics and KPI dashboards; Reporting service performance and trends; Supporting data-driven IT decisions'},
  {person:'anthony',responsibility:'Executive IT advisory and decision support',is_key:false,tasks:'Preparing executive-facing IT materials; Providing context during leadership discussions; Supporting executive decision-making on systems and risk; Acting as escalation point for strategic questions'},
  {person:'anthony',responsibility:'Enterprise software licensing and renewal management',is_key:false,tasks:'Managing software licensing and renewals; Auditing license usage and compliance; Coordinating renewals across departments'},
  {person:'anthony',responsibility:'Cloud and SaaS cost monitoring and optimization',is_key:false,tasks:'Monitoring SaaS usage and spend; Identifying cost optimization opportunities; Supporting finance with system access and reporting'},
  {person:'anthony',responsibility:'Email and collaboration platform administration and security',is_key:false,tasks:'Managing Google Workspace licensing and entitlements; Managing Google Groups and shared drive structures; Troubleshooting email delivery and routing; Managing spam filtering and email security; Supporting executive email and calendar issues'},
  {person:'geremia',responsibility:'Security operations and incident response',is_key:false,tasks:'Investigating suspicious emails and account compromise; Responding to security incidents and escalations; Managing endpoint protection tooling; Executing incident containment and remediation; Supporting post-incident analysis'},
  {person:'geremia',responsibility:'Security architecture, risk management, and compliance governance',is_key:true,tasks:'Managing firewall rules and documentation; Managing vulnerability scanning and patch prioritization; Supporting HIPAA and security audits; Maintaining audit evidence and compliance documentation; Running security awareness and training efforts'},
  {person:'geremia',responsibility:'Enterprise network architecture and operations (SD-WAN, LAN, Wi-Fi)',is_key:true,tasks:'Architecting and maintaining SD-WAN infrastructure; Managing switch configurations and VLANs; Managing IP addressing and segmentation; Managing wireless access point configuration; Maintaining network diagrams and documentation'},
  {person:'geremia',responsibility:'ISP, bandwidth, and connectivity vendor management',is_key:false,tasks:'Managing ISP relationships and contracts; Troubleshooting outages and escalations; Coordinating circuit changes and failover behavior'},
  {person:'geremia',responsibility:'Network monitoring, alerting, and performance management',is_key:false,tasks:'Managing network monitoring tools; Configuring alerts and thresholds; Troubleshooting performance issues; Supporting proactive issue detection'},
  {person:'geremia',responsibility:'Remote access and VPN services',is_key:false,tasks:'Managing VPN configuration and access; Supporting secure remote connectivity; Troubleshooting remote access issues'},
  {person:'geremia',responsibility:'Server, virtualization, and compute infrastructure management',is_key:false,tasks:'Managing server hardware and local infrastructure; Managing virtualization platforms and VMs; Monitoring compute resource usage'},
  {person:'geremia',responsibility:'Data center strategy and infrastructure migrations',is_key:false,tasks:'Planning and executing server migrations; Coordinating data center transitions; Supporting infrastructure consolidation efforts'},
  {person:'geremia',responsibility:'Backup, disaster recovery, and business continuity operations',is_key:true,tasks:'Managing backup systems and schedules; Performing backup verification and recovery testing; Supporting disaster recovery planning; Managing UPS systems and power protection'},
  {person:'geremia',responsibility:'Authentication, MFA, and account recovery governance',is_key:false,tasks:'Managing MFA deployment and enforcement; Handling MFA exceptions and recovery; Handling password resets and account recovery; Supporting secure authentication across systems'},
  {person:'geremia',responsibility:'Enterprise system migrations and major platform transitions',is_key:false,tasks:'Executing major system migrations; Coordinating cross-functional migration efforts; Supporting users during platform transitions'},
  {person:'geremia',responsibility:'Physical security and camera systems management',is_key:false,tasks:'Managing camera system deployments; Managing camera access permissions; Managing video retention and storage; Responding to camera outages or failures; Supporting facility safety technology needs'},
  {person:'francis',responsibility:'End-user hardware lifecycle management (procurement to retirement)',is_key:true,tasks:'Procuring laptops and end-user hardware; Imaging and deploying new devices; Managing device replacements and failures; Planning device refresh cycles; Managing e-waste and asset recovery'},
  {person:'francis',responsibility:'Printer, copier, and peripheral services management',is_key:false,tasks:'Managing printer and copier connectivity; Coordinating printer and copier moves; Managing copier lease returns and storage; Troubleshooting printing issues'},
  {person:'francis',responsibility:'Service desk ownership and end-user support operations',is_key:true,tasks:'Managing IT ticket intake and routing; Triage and prioritization of support requests; Resolving end-user support issues; Managing escalation paths'},
  {person:'francis',responsibility:'End-user adoption, training, and change enablement',is_key:false,tasks:'Supporting administrators during system changes; Supporting staff during rollouts and transitions; Managing end-user adoption challenges'},
  {person:'francis',responsibility:'Mobile device and telecom management',is_key:false,tasks:'Managing Apple Business Manager enrollment; Managing mobile device configuration and policies; Locking, wiping, or recovering lost devices; Managing telecom accounts and device plans; Troubleshooting mobile connectivity issues'},
  {person:'francis',responsibility:'Operational escalation handling and ambiguity resolution',is_key:false,tasks:'Managing day-to-day operational decision-making; Handling undefined or misrouted operational work; Acting as the default problem-solver for system ambiguity'},
  {person:'tom',responsibility:'Identity and access management (IAM) across enterprise systems',is_key:true,tasks:'Creating, modifying, disabling, and auditing user accounts; Managing user provisioning and deprovisioning workflows; Reconciling HR (UKG) data with IT systems; Maintaining identity consistency across platforms; Managing group-based access and role assignment'},
  {person:'tom',responsibility:'Network Administration',is_key:false,tasks:''},
  {person:'rogi',responsibility:'Clinical systems ownership (PointClickCare and clinical SaaS)',is_key:false,tasks:'Serving as SME for PointClickCare; Managing clinical system access and permissions; Supporting clinical SaaS platforms'},
  {person:'rogi',responsibility:'Clinical system integrations, workflows, and user enablement',is_key:false,tasks:'Supporting integrations between clinical and billing systems; Identifying workflow bottlenecks; Supporting clinical users during changes; Developing training approaches for clinical systems'},
  {person:'jon',responsibility:'ERP, document management, and database operations',is_key:false,tasks:'Supporting ERP (GP / Dynamics) systems; Managing DocLink configuration and workflows; Managing database operations and maintenance; Performing database patching and performance monitoring'},
];

// â”€â”€ AUTH â”€â”€
async function signIn() {
  const email = document.getElementById('authEmail').value.trim();
  const pw = document.getElementById('authPassword').value;
  const errEl = document.getElementById('authError');
  errEl.textContent = '';
  document.getElementById('authBtn').textContent = 'Signing inâ€¦';
  const { data, error } = await db.auth.signInWithPassword({ email, password: pw });
  document.getElementById('authBtn').textContent = 'Sign In';
  if (error) { errEl.textContent = error.message; return; }
  currentUser = data.user;
  showApp();
}

async function signOut() { await db.auth.signOut(); location.reload(); }

function toggleUserMenu(e) {
  document.getElementById('userDropdown').classList.toggle('open');
}
document.addEventListener('click', e => {
  if (!e.target.closest('#userChip')) document.getElementById('userDropdown')?.classList.remove('open');
});

// â”€â”€ INIT â”€â”€
async function init() {
  const { data: { session } } = await db.auth.getSession();
  document.getElementById('loadingOverlay').style.display = 'none';
  if (session?.user) { currentUser = session.user; showApp(); }
  else document.getElementById('authScreen').style.display = 'flex';
}

async function showApp() {
  const email = currentUser.email;
  const name = email.split('@')[0];
  const initials = name.slice(0,2).toUpperCase();
  document.getElementById('topbarAvatar').textContent = initials;
  document.getElementById('userAvatarSm').textContent = initials;
  document.getElementById('userChipName').textContent = name;
  document.getElementById('dropdownName').textContent = name;
  document.getElementById('dropdownEmail').textContent = email;
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('appLayout').style.display = 'grid';
  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  renderNav('team');
  await loadData();
  renderBoard();
  renderHeatmap();
  await loadChangeLog();
}

// â”€â”€ DATA â”€â”€
async function loadData() {
  const { data, error } = await db.from('responsibilities').select('*').order('sort_order');
  if (error || !data || data.length === 0) { await seedData(); return loadData(); }

  boardData = { current: {}, future: {} };
  PEOPLE.forEach(p => { boardData.current[p.key] = []; boardData.future[p.key] = []; });

  data.forEach(row => {
    const cp = row.assigned_to_current || 'backlog';
    const fp = row.assigned_to_future || 'backlog';
    const base = { id: row.id, text: row.responsibility, tasks: row.tasks || '', is_key_current: row.is_key_current||false, is_key_future: row.is_key_future||false, assigned_current: cp, assigned_future: fp };
    if (boardData.current[cp]) boardData.current[cp].push({ ...base, is_key: base.is_key_current });
    if (boardData.future[fp]) boardData.future[fp].push({ ...base, is_key: base.is_key_future });
  });
}

async function seedData() {
  showToast('First run â€” seedingâ€¦', 'info');
  const futureTexts = new Set(SEED_FUTURE.map(f => f.responsibility));
  const futureRows = SEED_FUTURE.map((item, i) => ({ responsibility: item.responsibility, tasks: item.tasks, is_key_current: false, is_key_future: item.is_key, assigned_to_current: 'backlog', assigned_to_future: item.person, sort_order: i }));
  let idx = futureRows.length;
  const currentRows = SEED_CURRENT_TASKS.filter(r => !futureTexts.has(r)).map(text => ({ responsibility: text, tasks: '', is_key_current: false, is_key_future: false, assigned_to_current: 'backlog', assigned_to_future: 'backlog', sort_order: idx++ }));
  const all = [...futureRows, ...currentRows];
  for (let i = 0; i < all.length; i += 50) await db.from('responsibilities').insert(all.slice(i, i+50));
  showToast('Seeded âœ“', 'success');
}

// â”€â”€ RENDER KANBAN â”€â”€
function renderBoard() {
  const board = document.getElementById('kanbanBoard');
  board.innerHTML = '';
  const data = boardData[currentState];

  PEOPLE.forEach(person => {
    const cards = data[person.key] || [];
    const col = document.createElement('div');
    col.className = 'column';
    col.dataset.person = person.key;

    const header = document.createElement('div');
    header.className = 'column-header';

    if (person.color) {
      const av = document.createElement('div');
      av.className = 'column-avatar';
      av.style.background = person.color;
      av.textContent = person.initials;
      header.appendChild(av);
    }

    const nameEl = document.createElement('div');
    nameEl.className = 'column-name';
    nameEl.textContent = person.key === 'backlog' ? 'Unassigned' : person.name;
    header.appendChild(nameEl);

    const countEl = document.createElement('div');
    countEl.className = 'column-count';
    countEl.textContent = `${cards.length} ${cards.length === 1 ? 'responsibility' : 'responsibilities'}`;
    header.appendChild(countEl);
    col.appendChild(header);

    const cardsEl = document.createElement('div');
    cardsEl.className = 'column-cards';
    cardsEl.dataset.person = person.key;

    if (cards.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'column-empty';
      empty.textContent = person.key === 'backlog' ? 'All assigned âœ“' : 'Drop here';
      cardsEl.appendChild(empty);
    } else {
      cards.forEach(card => cardsEl.appendChild(createCard(card)));
    }

    cardsEl.addEventListener('dragover', onDragOver);
    cardsEl.addEventListener('drop', onDrop);
    cardsEl.addEventListener('dragleave', onDragLeave);
    col.appendChild(cardsEl);

    if (person.key === 'backlog') {
      const addArea = document.createElement('div');
      addArea.className = 'backlog-add';
      addArea.innerHTML = `<textarea class="backlog-textarea" id="newRespInput" placeholder="Add a new responsibilityâ€¦"></textarea><button class="backlog-add-btn" onclick="addResponsibility()">+ Add</button>`;
      col.appendChild(addArea);
    }

    board.appendChild(col);
  });
}

function createCard(card) {
  const el = document.createElement('div');
  el.className = 'resp-card' + (card.is_key ? ' is-key' : '');
  el.draggable = true;
  el.dataset.id = card.id;
  el.addEventListener('dragstart', onDragStart);
  el.addEventListener('dragend', onDragEnd);

  const tasks = card.tasks ? card.tasks.split(';').map(t => t.trim()).filter(Boolean) : [];
  const badgeClass = currentState === 'current' ? 'badge-current' : 'badge-future';
  const badgeLabel = currentState === 'current' ? 'CURRENT' : 'FUTURE';

  el.innerHTML = `
    <div class="card-text">${card.text}</div>
    <div class="card-footer">
      <span class="card-state-badge ${badgeClass}">${badgeLabel}</span>
      <div class="card-actions">
        ${tasks.length ? `<button class="tasks-toggle" title="Show tasks" onclick="toggleTasks(this)">â–¾</button>` : ''}
        <button class="key-toggle" title="${card.is_key ? 'Remove key' : 'Mark as key'}" onclick="toggleKey(this,'${card.id}')">ðŸ”‘</button>
      </div>
    </div>
    ${tasks.length ? `<div class="card-tasks">${tasks.map(t=>`<div class="card-task-item">${t}</div>`).join('')}</div>` : ''}
  `;
  return el;
}

// â”€â”€ DRAG & DROP â”€â”€
function onDragStart(e) {
  dragCard = e.currentTarget;
  dragSource = dragCard.closest('.column-cards').dataset.person;
  dragCard.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', dragCard.dataset.id);
}
function onDragEnd() { if (dragCard) dragCard.classList.remove('dragging'); document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over')); }
function onDragOver(e) { e.preventDefault(); e.currentTarget.closest('.column').classList.add('drag-over'); }
function onDragLeave(e) { const col = e.currentTarget.closest('.column'); if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over'); }
function onDrop(e) {
  e.preventDefault();
  e.currentTarget.closest('.column').classList.remove('drag-over');
  const cardId = e.dataTransfer.getData('text/plain');
  const targetPerson = e.currentTarget.dataset.person;
  if (!cardId || dragSource === targetPerson) return;
  moveCard(cardId, dragSource, targetPerson);
}

function moveCard(cardId, from, to) {
  const data = boardData[currentState];
  const idx = data[from].findIndex(c => c.id === cardId);
  if (idx === -1) return;
  const card = data[from].splice(idx, 1)[0];
  if (currentState === 'current') card.assigned_current = to;
  else card.assigned_future = to;
  data[to].push(card);
  markUnsaved();
  const fromName = PEOPLE.find(p => p.key === from)?.name || from;
  const toName = PEOPLE.find(p => p.key === to)?.name || to;
  addLogEntry(`Moved "${card.text}" â†’ ${toName} (${currentState})`);
  renderBoard();
  renderHeatmap();
}

// â”€â”€ KEY TOGGLE â”€â”€
function toggleKey(btn, cardId) {
  const data = boardData[currentState];
  let card = null;
  for (const p of PEOPLE) { card = data[p.key]?.find(c => c.id === cardId); if (card) break; }
  if (!card) return;
  if (currentState === 'current') { card.is_key_current = !card.is_key_current; card.is_key = card.is_key_current; }
  else { card.is_key_future = !card.is_key_future; card.is_key = card.is_key_future; }
  markUnsaved();
  addLogEntry(`${card.is_key ? 'Marked' : 'Unmarked'} "${card.text}" as key (${currentState})`);
  renderBoard();
  renderHeatmap();
}

// â”€â”€ TASKS EXPAND â”€â”€
function toggleTasks(btn) {
  const tasks = btn.closest('.resp-card').querySelector('.card-tasks');
  if (!tasks) return;
  tasks.classList.toggle('open');
  btn.textContent = tasks.classList.contains('open') ? 'â–´' : 'â–¾';
}

// â”€â”€ HEATMAP â”€â”€
function renderHeatmap() {
  const body = document.getElementById('heatmapBody');
  body.innerHTML = '';
  const data = boardData[currentState];

  // Collect all assigned responsibilities (non-backlog)
  const allItems = [];
  TEAM.forEach(person => {
    (data[person.key] || []).forEach(card => {
      allItems.push({ ...card, owner: person.key });
    });
  });

  // Also include backlog items in heatmap (shown as unassigned)
  const backlogItems = (data['backlog'] || []).map(card => ({ ...card, owner: 'backlog' }));
  const combined = [...allItems, ...backlogItems];

  // Group by responsibility text â€” find if same text appears under multiple people
  const byText = {};
  combined.forEach(item => {
    if (!byText[item.text]) byText[item.text] = [];
    byText[item.text].push(item);
  });

  // Render
  Object.entries(byText).forEach(([text, items]) => {
    const owners = items.map(i => i.owner);
    const isKey = items.some(i => i.is_key);
    const assignedCount = owners.filter(o => o !== 'backlog').length;

    const tr = document.createElement('tr');

    const tdLabel = document.createElement('td');
    tdLabel.style.fontWeight = isKey ? '600' : 'normal';
    tdLabel.style.color = isKey ? 'var(--text-primary)' : '';
    tdLabel.textContent = text;
    tr.appendChild(tdLabel);

    TEAM.forEach(person => {
      const td = document.createElement('td');
      const owns = owners.includes(person.key);
      if (owns) {
        const cell = document.createElement('div');
        cell.className = 'hm-cell ' + (isKey ? 'key-owner' : assignedCount === 1 ? 'sole' : 'shared');
        cell.textContent = isKey ? 'ðŸ”‘' : 'â—';
        td.appendChild(cell);
      } else {
        const cell = document.createElement('div');
        cell.className = 'hm-cell empty';
        td.appendChild(cell);
      }
      tr.appendChild(td);
    });

    body.appendChild(tr);
  });
}

// â”€â”€ TABS â”€â”€
function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tabKanban').className = 'tab-btn' + (tab === 'kanban' ? ' active' : '');
  document.getElementById('tabHeatmap').className = 'tab-btn' + (tab === 'heatmap' ? ' active' : '');
  document.getElementById('panelKanban').className = 'tab-panel' + (tab === 'kanban' ? ' active' : '');
  document.getElementById('panelHeatmap').className = 'tab-panel' + (tab === 'heatmap' ? ' active' : '');
  if (tab === 'heatmap') renderHeatmap();
}

// â”€â”€ STATE â”€â”€
function setState(state) {
  currentState = state;
  document.getElementById('btnCurrent').className = 'state-btn' + (state === 'current' ? ' active-current' : '');
  document.getElementById('btnFuture').className = 'state-btn' + (state === 'future' ? ' active-future' : '');
  if (state === 'future') document.body.classList.add('future-mode');
  else document.body.classList.remove('future-mode');
  renderBoard();
  renderHeatmap();
}

// â”€â”€ SAVE â”€â”€
async function saveState() {
  showToast('Savingâ€¦', 'info');
  const updates = [];
  const seen = new Set();
  ['current','future'].forEach(state => {
    PEOPLE.forEach(person => {
      (boardData[state][person.key] || []).forEach(card => {
        if (!seen.has(card.id)) {
          seen.add(card.id);
          updates.push({ id: card.id, responsibility: card.text, tasks: card.tasks, is_key_current: card.is_key_current, is_key_future: card.is_key_future, assigned_to_current: card.assigned_current, assigned_to_future: card.assigned_future });
        }
      });
    });
  });
  let ok = true;
  for (let i = 0; i < updates.length; i += 50) {
    const { error } = await db.from('responsibilities').upsert(updates.slice(i, i+50));
    if (error) { ok = false; console.error(error); }
  }
  if (ok) { hasUnsaved = false; document.getElementById('unsavedBadge').classList.remove('visible'); showToast('Saved âœ“', 'success'); }
  else showToast('Save failed', 'error');
}

async function applyToBios() { await saveState(); addLogEntry(`Applied ${currentState} state to bios`); showToast('Applied to bios âœ“', 'success'); }

function clearAll() {
  if (!confirm(`Move all ${currentState} assignments back to Unassigned?`)) return;
  const data = boardData[currentState];
  const all = [];
  PEOPLE.forEach(p => { all.push(...data[p.key]); data[p.key] = []; });
  all.forEach(card => { if (currentState === 'current') card.assigned_current = 'backlog'; else card.assigned_future = 'backlog'; data['backlog'].push(card); });
  markUnsaved();
  addLogEntry(`Cleared all ${currentState} assignments`);
  renderBoard();
  renderHeatmap();
}

async function addResponsibility() {
  const input = document.getElementById('newRespInput');
  const text = input.value.trim();
  if (!text) return;
  const { data, error } = await db.from('responsibilities').insert({ responsibility: text, tasks: '', is_key_current: false, is_key_future: false, assigned_to_current: 'backlog', assigned_to_future: 'backlog', sort_order: 9999 }).select().single();
  if (error) { showToast('Failed to add', 'error'); return; }
  const card = { id: data.id, text: data.responsibility, tasks: '', is_key: false, is_key_current: false, is_key_future: false, assigned_current: 'backlog', assigned_future: 'backlog' };
  boardData.current['backlog'].push({ ...card });
  boardData.future['backlog'].push({ ...card });
  addLogEntry(`Added: "${text}"`);
  input.value = '';
  renderBoard();
  showToast('Added âœ“', 'success');
}

// â”€â”€ CHANGE LOG â”€â”€
async function loadChangeLog() {
  const { data } = await db.from('change_log').select('*').order('created_at', { ascending: false }).limit(100);
  if (data?.length) { changeLog = data; renderLog(); }
}
function addLogEntry(action) {
  const entry = { user_email: currentUser?.email || 'unknown', action, state: currentState, created_at: new Date().toISOString() };
  changeLog.unshift(entry);
  db.from('change_log').insert(entry);
  renderLog();
}
function renderLog() {
  const list = document.getElementById('logList');
  if (!changeLog.length) { list.innerHTML = '<div class="log-empty">No changes yet.</div>'; return; }
  list.innerHTML = changeLog.slice(0,50).map(e => {
    const time = new Date(e.created_at).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
    return `<div class="log-item"><div class="log-action">${e.action}</div><div class="log-meta">${(e.user_email||'').split('@')[0]} Â· ${time}</div></div>`;
  }).join('');
}
function toggleLog() { document.getElementById('logDrawer').classList.toggle('open'); }
function markUnsaved() { hasUnsaved = true; document.getElementById('unsavedBadge').classList.add('visible'); }
function showToast(msg, type='info') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast show ${type}`;
  setTimeout(() => { t.className = 'toast'; }, 2500);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
