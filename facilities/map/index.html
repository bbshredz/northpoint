<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Map — NorthPoint</title>
    <link rel="stylesheet" href="/northpoint.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/auth.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* ── Layout overrides for full-height map ── */
        html { height: 100%; }
        body { height: 100%; overflow: hidden; }
        .layout { height: 100%; }
        .main { height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .content { flex: 1; min-height: 0; padding: 0; position: relative; overflow: hidden; }

        /* ── Map container ── */
        #map {
            width: 100%;
            height: 100%;
            background: #0a0f1e;
        }

        /* ── Pulse marker base ── */
        .np-marker {
            position: relative;
            width: 14px;
            height: 14px;
        }
        .np-marker .dot {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            z-index: 2;
        }
        .np-marker .ring {
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            z-index: 1;
            animation: np-pulse 2.4s ease-out infinite;
            opacity: 0;
        }

        /* Status: online — green */
        .s-online .dot  { background: #22c55e; box-shadow: 0 0 6px #22c55e88; }
        .s-online .ring { border: 2px solid #22c55e; }

        /* Status: warning — amber */
        .s-warning .dot  { background: #f59e0b; box-shadow: 0 0 6px #f59e0b88; }
        .s-warning .ring { border: 2px solid #f59e0b; }

        /* Status: offline — red */
        .s-offline .dot  { background: #ef4444; box-shadow: 0 0 6px #ef444488; }
        .s-offline .ring { border: 2px solid #ef4444; animation-duration: 1.6s; }

        /* Status: incoming — dimmed dashed outline */
        .s-incoming .dot  { background: transparent; border: 2px dashed #64748b; }
        .s-incoming .ring { display: none; }

        /* Status: service — blue */
        .s-service .dot  { background: #3b82f6; box-shadow: 0 0 6px #3b82f688; }
        .s-service .ring { border: 2px solid #3b82f6; }

        @keyframes np-pulse {
            0%   { transform: scale(0.6); opacity: 0.8; }
            70%  { transform: scale(2.4); opacity: 0; }
            100% { transform: scale(2.4); opacity: 0; }
        }

        /* Stagger rings so nearby facilities don't pulse in sync */
        .np-marker:nth-child(odd) .ring { animation-delay: 1.2s; }

        /* ── Loading overlay ── */
        #map-loading {
            position: absolute;
            inset: 0;
            background: #0a0f1e;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            gap: 12px;
            transition: opacity 0.4s;
        }
        #map-loading.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner {
            width: 28px;
            height: 28px;
            border: 2px solid #1e293b;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-label { font-size: 12px; color: #475569; letter-spacing: 0.08em; }

        /* ── Legend ── */
        #map-legend {
            position: absolute;
            bottom: 28px;
            left: 12px;
            z-index: 500;
            background: rgba(10, 15, 30, 0.88);
            backdrop-filter: blur(8px);
            border: 1px solid #1e293b;
            border-radius: 8px;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 7px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #94a3b8;
            white-space: nowrap;
        }
        .legend-dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .legend-dot.s-online  { background: #22c55e; }
        .legend-dot.s-warning { background: #f59e0b; }
        .legend-dot.s-offline { background: #ef4444; }
        .legend-dot.s-service { background: #3b82f6; }
        .legend-dot.s-incoming { background: transparent; border: 1.5px dashed #64748b; }

        /* ── Detail panel ── */
        #facility-panel {
            position: absolute;
            top: 16px;
            right: 16px;
            bottom: 16px;
            width: 300px;
            background: rgba(10, 15, 30, 0.94);
            backdrop-filter: blur(12px);
            border: 1px solid #1e293b;
            border-radius: 12px;
            z-index: 500;
            transform: translateX(340px);
            transition: transform 0.32s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #facility-panel.open { transform: translateX(0); }
        #facility-panel.panel-refresh .panel-header,
        #facility-panel.panel-refresh .panel-body { opacity: 0.15; transition: opacity 0.1s; }

        .panel-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 26px;
            height: 26px;
            border: none;
            background: #1e293b;
            border-radius: 6px;
            color: #94a3b8;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 2;
        }
        .panel-close:hover { background: #334155; color: #e2e8f0; }

        .panel-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid #1e293b;
        }
        .panel-region {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 6px;
        }
        .panel-name {
            font-family: 'DM Serif Display', serif;
            font-size: 18px;
            color: #f1f5f9;
            line-height: 1.2;
            margin-bottom: 10px;
        }
        .panel-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            font-weight: 500;
            padding: 3px 9px;
            border-radius: 20px;
        }
        .psb-online  { background: #052e16; color: #4ade80; }
        .psb-warning { background: #1c1200; color: #fbbf24; }
        .psb-offline { background: #1f0404; color: #f87171; }
        .psb-incoming { background: #0f172a; color: #64748b; border: 1px solid #334155; }
        .psb-service  { background: #0c1a3d; color: #60a5fa; }

        .panel-body {
            flex: 1;
            padding: 16px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .panel-row {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .panel-row-label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #475569;
        }
        .panel-row-value {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.4;
        }
        .panel-row-value a {
            color: #60a5fa;
            text-decoration: none;
        }
        .panel-row-value a:hover { text-decoration: underline; }

        .panel-divider {
            height: 1px;
            background: #1e293b;
        }

        .panel-footer {
            padding: 14px 20px;
            border-top: 1px solid #1e293b;
            display: flex;
            gap: 8px;
        }
        .panel-btn {
            flex: 1;
            padding: 8px 0;
            border-radius: 7px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: block;
            border: 1px solid transparent;
            transition: background 0.15s;
        }
        .panel-btn-primary {
            background: #1d4ed8;
            color: #fff;
            border-color: #1d4ed8;
        }
        .panel-btn-primary:hover { background: #2563eb; }
        .panel-btn-secondary {
            background: transparent;
            color: #94a3b8;
            border-color: #334155;
        }
        .panel-btn-secondary:hover { background: #1e293b; color: #e2e8f0; }

        /* ── Leaflet overrides ── */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: none !important;
        }
        .leaflet-control-zoom a {
            background: rgba(10, 15, 30, 0.88) !important;
            border: 1px solid #1e293b !important;
            color: #94a3b8 !important;
            backdrop-filter: blur(8px);
        }
        .leaflet-control-zoom a:hover {
            background: #1e293b !important;
            color: #e2e8f0 !important;
        }
        .leaflet-control-attribution {
            background: rgba(10, 15, 30, 0.7) !important;
            color: #334155 !important;
            font-size: 9px !important;
        }
        .leaflet-control-attribution a { color: #475569 !important; }
    </style>
</head>
<body class="mod-facilities">
<div class="layout">
    <div id="rail-mount"></div>
    <div class="main">
        <header class="topbar">
            <div class="topbar-left">
                <a href="/index.html" class="topbar-name">NorthPoint</a>
                <div class="topbar-sep"></div>
                <a href="/facilities/index.html" class="topbar-section" style="text-decoration:none;color:inherit;">Facilities</a>
                <div class="topbar-sep"></div>
                <span class="topbar-section">Map</span>
            </div>
            <div class="topbar-right">
                <span class="topbar-date" id="currentDate"></span>
                <span class="topbar-role" id="topbarRole"></span>
            </div>
        </header>

        <div class="content">
            <!-- Map -->
            <div id="map"></div>

            <!-- Loading overlay -->
            <div id="map-loading">
                <div class="loading-spinner"></div>
                <div class="loading-label">Loading facilities&hellip;</div>
            </div>

            <!-- Legend -->
            <div id="map-legend">
                <div class="legend-item"><div class="legend-dot s-online"></div> Operational</div>
                <div class="legend-item"><div class="legend-dot s-warning"></div> Needs Attention</div>
                <div class="legend-item"><div class="legend-dot s-offline"></div> Offline</div>
                <div class="legend-item"><div class="legend-dot s-service"></div> Service Center</div>
                <div class="legend-item"><div class="legend-dot s-incoming"></div> Incoming</div>
            </div>

            <!-- Facility detail panel -->
            <div id="facility-panel">
                <button class="panel-close" id="panel-close" title="Close">&times;</button>
                <div class="panel-header">
                    <div class="panel-region" id="panel-region"></div>
                    <div class="panel-name" id="panel-name"></div>
                    <span class="panel-status-badge" id="panel-status"></span>
                </div>
                <div class="panel-body">
                    <div class="panel-row">
                        <div class="panel-row-label">Address</div>
                        <div class="panel-row-value" id="panel-address"></div>
                    </div>
                    <div class="panel-divider"></div>
                    <div class="panel-row">
                        <div class="panel-row-label">Phone</div>
                        <div class="panel-row-value" id="panel-phone"></div>
                    </div>
                    <div class="panel-row">
                        <div class="panel-row-label">Administrator</div>
                        <div class="panel-row-value" id="panel-admin"></div>
                    </div>
                    <div class="panel-row">
                        <div class="panel-row-label">Employees</div>
                        <div class="panel-row-value" id="panel-emp"></div>
                    </div>
                    <div id="panel-notes-wrap" class="panel-row" style="display:none">
                        <div class="panel-row-label">Notes</div>
                        <div class="panel-row-value" id="panel-notes"></div>
                    </div>
                </div>
                <div class="panel-footer">
                    <a id="panel-maps-btn" class="panel-btn panel-btn-primary" href="#" target="_blank">Google Maps</a>
                    <a id="panel-tickets-btn" class="panel-btn panel-btn-secondary" href="#" target="_blank">Tickets</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/nav.js"></script>
<script>
// ── Auth + init ──────────────────────────────────────────────────────────────
npInit(null).then(session => {
    if (!session) return;
    npPopulateTopbar();
    renderNav('facilities');
    loadMap();
});

// ── Map ──────────────────────────────────────────────────────────────────────
let _map = null;
let _openFacilityId = null;

async function loadMap() {
    // Init Leaflet
    _map = L.map('map', {
        center: [36.8, -119.4],
        zoom: 7,
        zoomControl: false,
    });

    // Zoom control — top left so panel doesn't overlap
    L.control.zoom({ position: 'topleft' }).addTo(_map);

    // CARTO dark tiles
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19,
    }).addTo(_map);

    // Load facilities from Supabase
    const { data, error } = await _npSupabase
        .from('facilities')
        .select('*')
        .order('name');

    const loading = document.getElementById('map-loading');
    loading.classList.add('hidden');
    setTimeout(() => { loading.style.display = 'none'; }, 400);

    if (error || !data) {
        console.error('Facilities load error:', error);
        return;
    }

    data.forEach(f => addMarker(f));
}

function statusClass(f) {
    if (f.is_service_center) return 's-service';
    if (f.is_incoming) return 's-incoming';
    const s = (f.status || 'online').toLowerCase();
    if (s === 'warning' || s === 'warn') return 's-warning';
    if (s === 'offline' || s === 'down') return 's-offline';
    return 's-online';
}

function addMarker(f) {
    const sc = statusClass(f);
    const icon = L.divIcon({
        className: '',
        html: `<div class="np-marker ${sc}"><div class="ring"></div><div class="dot"></div></div>`,
        iconSize: [14, 14],
        iconAnchor: [7, 7],
    });

    const marker = L.marker([f.lat, f.lng], { icon }).addTo(_map);
    marker.on('click', () => openPanel(f));
}

// ── Detail panel ─────────────────────────────────────────────────────────────
function populatePanel(f) {
    document.getElementById('panel-region').textContent = f.region || '';
    document.getElementById('panel-name').textContent = f.name;

    const badge = document.getElementById('panel-status');
    const badgeText = f.is_service_center ? 'Service Center'
        : f.is_incoming ? 'Incoming'
        : (f.status === 'warning' ? 'Needs Attention'
        : f.status === 'offline' ? 'Offline'
        : 'Operational');
    const badgeClass = f.is_service_center ? 'psb-service'
        : f.is_incoming ? 'psb-incoming'
        : (f.status === 'warning' ? 'psb-warning'
        : f.status === 'offline' ? 'psb-offline'
        : 'psb-online');
    badge.className = `panel-status-badge ${badgeClass}`;
    badge.textContent = badgeText;

    const addr = `${f.address}, ${f.city}, ${f.state} ${f.zip}`;
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    document.getElementById('panel-address').innerHTML =
        `<a href="${mapsUrl}" target="_blank">${f.address}<br>${f.city}, ${f.state} ${f.zip}</a>`;

    document.getElementById('panel-phone').textContent = f.phone || '—';
    document.getElementById('panel-admin').textContent = f.admin_name || '—';
    document.getElementById('panel-emp').textContent = f.emp_count ? `${f.emp_count} employees` : '—';

    const notesWrap = document.getElementById('panel-notes-wrap');
    if (f.notes) {
        document.getElementById('panel-notes').textContent = f.notes;
        notesWrap.style.display = '';
    } else {
        notesWrap.style.display = 'none';
    }

    document.getElementById('panel-maps-btn').href = mapsUrl;
    const ticketsBtn = document.getElementById('panel-tickets-btn');
    if (f.tickets_url) {
        ticketsBtn.href = f.tickets_url;
        ticketsBtn.style.display = '';
    } else {
        ticketsBtn.removeAttribute('href');
        ticketsBtn.style.display = 'none';
    }
}

function openPanel(f) {
    const panel = document.getElementById('facility-panel');

    // Same facility — toggle closed
    if (_openFacilityId === f.id) {
        closePanel();
        return;
    }

    if (panel.classList.contains('open')) {
        // Different facility while open — flash content, no slide
        panel.classList.add('panel-refresh');
        setTimeout(() => {
            populatePanel(f);
            panel.classList.remove('panel-refresh');
        }, 150);
    } else {
        // First open — slide drawer in
        populatePanel(f);
        panel.classList.add('open');
    }

    _openFacilityId = f.id;
}

function closePanel() {
    document.getElementById('facility-panel').classList.remove('open');
    _openFacilityId = null;
}

document.getElementById('panel-close').addEventListener('click', closePanel);
</script>
</body>
</html>
